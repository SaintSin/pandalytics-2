---
// src/components/Analytics.astro
// Clean analytics implementation
// upated 19-08-25 14:48

const siteId = Astro.site ? new URL(Astro.site).hostname : "localhost";
---

<script define:vars={{ siteId }} is:inline>
  (function () {
    // Skip in development
    if (
      location.hostname === "localhost" ||
      location.hostname === "127.0.0.1"
    ) {
      console.log("ðŸš§ Analytics disabled in development");
      return;
    }

    function generateUUID() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
        const r = (Math.random() * 16) | 0;
        const v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      });
    }

    function initializeAnalytics() {
      // Get or create session
      let sessionId = sessionStorage.getItem("session_id");
      if (!sessionId) {
        sessionId = generateUUID();
        sessionStorage.setItem("session_id", sessionId);
        sessionStorage.setItem("session_start", Date.now().toString());
      }

      // Track page visits
      const pageKey = `page_${location.pathname}`;
      const isFirstVisit = !sessionStorage.getItem(pageKey);
      if (isFirstVisit) {
        sessionStorage.setItem(pageKey, Date.now().toString());
      }

      // Basic metrics
      const metrics = {
        session_id: sessionId,
        site_id: siteId,
        url: location.href,
        path: location.pathname,
        referrer: document.referrer || null,
        screen_width: window.screen.width,
        screen_height: window.screen.height,
        user_agent: navigator.userAgent,
        timestamp: Date.now(),
        is_first_visit: isFirstVisit,
      };

      console.log("ðŸ“Š Analytics:", metrics);

      // Send metrics
      const blob = new Blob([JSON.stringify(metrics)], {
        type: "application/json",
      });

      if (navigator.sendBeacon) {
        navigator.sendBeacon("/.netlify/functions/pandalytics", blob);
      } else {
        fetch("/.netlify/functions/pandalytics", {
          method: "POST",
          body: JSON.stringify(metrics),
          headers: { "Content-Type": "application/json" },
          keepalive: true,
        }).catch(() => {});
      }
    }

    // Initialize on page load
    initializeAnalytics();

    // Handle Astro view transitions
    document.addEventListener("astro:page-load", initializeAnalytics);
  })();
</script>
